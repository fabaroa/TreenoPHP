<?php
//$Id: licenseFuncs.php 14863 2012-06-27 20:14:41Z cz $
if(file_exists('../db/db_common.php')) {
	include_once '../db/db_common.php';
	include_once '../settings/settings.php';
	include_once '../lib/license.php';
	include_once '../lib/utility.php';
} else {
	include_once 'db/db_common.php';
	include_once 'settings/settings.php';
	include_once 'lib/license.php';
	include_once 'lib/utility.php';
}

function enterLicense($enArr,$user,$db_dept,$db_doc) {
	$jsonLic = registerLicense($enArr['license']);
	echo json_encode($jsonLic);
}

function registerLicense($lic) {
	global $DEFS;
	$license = trim($lic);
	$cache = getCacheLiteObject();
	$cache->remove('license');
	$licObj = new license(NULL,NULL,NULL,NULL,$license);
	if($licObj->hasValidMAC()) {
		$db_doc = getDbObject('docutron');
		
		$sArr = array('SUM(dept_licenses)');
		$dLic = getTableInfo($db_doc,'licenses',$sArr,array(),'queryOne');

		$uArr = array('max_licenses' => ($licObj->numLicenses - $dLic));
		$wArr = array();
		updateTableInfo($db_doc,'global_licenses',$uArr,$wArr);

		$uArr = array('enabled' => 0);
		$wArr = array();
		updateTableInfo($db_doc,'modules',$uArr,$wArr);
		foreach($licObj->modules AS $mod) {
			$uArr = array('enabled' => 1);
			$wArr = array('real_name' => $mod);
			updateTableInfo($db_doc,'modules',$uArr,$wArr);
		}

		$wArr = array('department' => 'system',
					'k' => 'system_license');
		deleteTableInfo($db_doc,'settings',$wArr);
		$insertArr = array('k' => 'system_license',
				'value' => $license,
				'department' => 'system');
		$db_doc->extended->autoExecute('settings',$insertArr);
		deleteTableInfo($db_doc, 'user_polls', array());
		deleteTableInfo($db_doc, 'user_security', array());
	}
	$jsonLic = array('valid' => $licObj->hasValidMAC());
	return $jsonLic;
}

function bitXOR($num1, $num2) {
	$bitStr = '';
	for($i = 0; $i < strlen($num1); $i++) {
		if($num1{$i} == $num2{$i}) {
			$bitStr .= '0';
		} else {
			$bitStr .= '1';
		}
	}
	return $bitStr;
}

function isValidLicense($db_doc) {
	//error_log("isValidLicense()  db_doc: ".$db_doc->database_name);
	global $DEFS;
	$cache = getCacheLiteObject();
	if( $license = $cache->get('license') ){
		//error_log("isValidLicense() got license from cache: ".$license);
		return $license;
	}
	
	error_log("isValidLicense() cannot get license from cache, will query DB: ".$db_doc->database_name);
	//check if there are two system licenses
	//if two try both licenses (for use in load balanced systems)
	$sArr = array( 'value' );
	$wArr=array( 'k'=>'system_license' );
	$licArr = getTableInfo( $db_doc, 'settings', $sArr, $wArr, 'queryCol' );
	$foundMac = false;
	foreach( $licArr as $lic ){
		$licObj = new license(NULL,NULL,NULL,NULL,$lic);
		if($licObj->mac == getServerMAC()) {
			$foundMac = true;
			break;
		}
	}
	if(!$foundMac) {
		error_log("MAC address doesn't match");
		$cache->save( false, 'license' );
		return false;
	}
	$sArr = array('max_licenses');
	$wArr = array();
	$numLic = getTableInfo($db_doc,'global_licenses',$sArr,$wArr,'queryOne');
	$sArr = array('SUM(dept_licenses)');
	//$numLic += getTableInfo($db_doc,'licenses',$sArr,array(),'queryOne');
	if($numLic > $licObj->numLicenses) {
		//error_log("number of licenses is greater than or equal to $numLic != {$licObj->numLicenses}");
		$cache->save( false, 'license' );
		return false;
	}
	$sArr = array('real_name');
	$wArr = array('department' => 'client_files',
				'enabled' => 1);
	$modArr = getTableInfo($db_doc,'modules',$sArr,$wArr,'queryCol');
	$diffArr = array_diff($modArr,$licObj->modules);
	if(count($diffArr) > 0) 
	{
		if (count($diffArr) == 1 && in_array("dwf",$diffArr))
		{
			//error_log("just dwf\n".print_r($licObj->modules,true));
		}
		else
		{
			error_log("modules don't match\n".print_r($diffArr,true));
			$cache->save( false, 'license' );
			return false;
		}
	}
	$dArr = explode("-",$licObj->expireDate);
	$expireDate = mktime(0,0,0,$dArr[1],$dArr[2],$dArr[0]);
	//If ExpireDate is 0, the license does not expire
	if((time() > $expireDate) && $licObj->expireDate != '1970-01-01') {
		error_log("license has expired");
		$cache->save( false, 'license' );
		return false;
	}
	//error_log("isValidLicense() save valid license to cache");
	$cache->save( true, 'license' );
	return true;	
}

function getServerMAC() {
	global $DEFS;
	if(substr(PHP_OS, 0, 3) == 'WIN') {
		$macList = shell_exec($DEFS['IPCONFIG_EXE'] . " /all");
		$macArr = explode("\n",trim($macList));
		foreach($macArr AS $mac) {
			if(strrpos($mac,'Physical Address') !== false) {
				$tmpmac = explode( ':', $mac );
				$macAddr = trim($tmpmac[1]);
				break;
			} else if(strrpos($mac,'Adresse physique') !== false) {
				$tmpmac = explode( ':', $mac );
				$macAddr = trim($tmpmac[1]);
				break;
			}
		}
	} else {
		$ethNum = 0;
		while (!file_exists("/sys/class/net/eth$ethNum/address")) {
		    $ethNum++;
		}
		$macAddr = trim(file_get_contents("/sys/class/net/eth$ethNum/address"));
	}
	$macAddr = str_replace(":","",$macAddr);
	$macAddr = str_replace("-","",$macAddr);
	$macAddr = str_replace(" ","",$macAddr);
	return strtoupper($macAddr);
}

function getPad() {
	return "0111100101110010010100100011001110011001110011011101011100111001111011000101000101000110000010101011110111101111001111010110001100000001000011110110100101101011011001010100000110111000100111010011010000011101001000100000110110011010110110100010100111101000001111110100111100011010111110111110110100011011100011101001000110101110111000110011100010111010110000100101101110001100000010000000010110000101101000111110011110001010011100010011001011100010111101000100101111001011110011001010000101101010000001011100000011001000110010001100100101110111100100111011011110101110010110011100101001111110110101110100101010001001010011100101001111101011010101101101000011000111100111101010100001011110111001010011001101000000010000011000011100100101110010000001001101110111111111000111010010001100110100111000010111110101110011000110011011110010111001010110010110101011111010101010100100101101011011000010010011100010001011010011101001100001101100110011110010110011010000100000000001000111001011101011100011011101011010110110000110011001000011001011001000000000110111011111100000000100100101100001110100101110100001011100011110110001000100010000011111101110100011100011100110111110010110111101011111000000101100000111100110000101110100111100111111101011110010010111011011011110011111011101111100001110010111100110110000010011000011001011100001101011110011011111100100000110110101011001010100010100001001000110110001110000101110100010111000110011010001011100110001101010110000101001010100011100101010010100100111111011101101010110000100010000101110101011000011100011000110001010010110111010101010111110000110010010011101001011000100101010010110110100010010011010101110011100100011111110100001010000011000111010110011001000010011011111111001110100100101000010110100100001101011100001001010111010100111001000101001010111100101110111011111010011100111111011001100010110000000010100100110001111111011000111111001101111001001110001110100011000101011011011111000101100001101110101010010101011011110110101010101010111000010001111100011010010101000111000111100101011011001011100100001001100110011001011001101001111000000111001001111110101011011000110101101110111111001110100100000010100011000011000011000110110111001001110010111010010000011110110100011010100000010001110101001010010101110000001100100011101110000010010011101110011100100111111010100101010101001000001110111001101110101100010111011101000000110001101001111000011100010111011100001011101110001000011010011110100011100010100011001110010011011001000101110101010111101011010100110111011001100101111001010000110001111001000000101001001000001111001111001000000001001111101111101001000110101011100001111010011100001011000000100101111011110011110001010111111100101111101100101010100111100010110111110011010000011111101110000001100100001010000011100101010001100000001100001000111110111011101100100111010101010111000011111010110110001010100010110111000111010011111110100100010001101100000010101001101010101101001100010111110000110101000010110010011001110000110110001010011110101000101101011101011011110111101101101010101011000111010011110111110010110010010011111010110011010100001010001110110100110110011010010010011100101000000001000101000111011001110000110101000100001111101011011101110000110101010110101101011001011111011101111000111011110101001011111001111001011000000010110111100001100010011110000100101110011011010111111111101010111111111110100111111010111011010001100111101001100000100010001011101101110001001111100000110110010101101101010101101001000110110001010111101001010100000001111010001101101010100100000001100110010010011110110101101101100111110010001001001111011001101100010011101110001000011110011100011111010011101001111001000000001100111000011000100110110110001111001000000111100101100010111101111101111100001111000100100000100110111111110000011101111001100011000111100011001111010010001011110101100110111100110001000100000011010111011001110110101001010101000101101011000100000001011011110111111011001101101000001100110111010110101111010110011011011001101010111001010010111011101011011110100110001000111100110100110101011011100101100111101011101010110001001110101111110000110010110111011001101000101100001111101101111101111110101000110111111000100011000100100100100100000011111101010111100000110001001011010001101000000000010010000000100111001011011111101011110111110110110100001011100001111011001011010101000001011010100111011001111001001110101101101110111010000110010100000111010101010101101111001000001111000011110001010000111000110101001000111111001101101010000000011100111011011111100000101001000000110100001111001100001110110000010101110000101001101011000100011010101001100001111101110010101010110011010110000011110111001110101011111100010010100011010001010001101011100100101001011101000001011011001011100010110000101110000000011101110000100100010000111000011110110111000101101100010110011101011011011000100000011101011011001011101110100110011111110001111011000010010101100100110111110010011101110110110011001011111001110100111111011111000001000011001111110011111001011001011100010011100110001111111110001011101001000011110011000100111100001010000101101110011101111001111101101100111001010111110001001011001110010011101010001100110000001110010001101010101000110010101110000011111011111110100000001100110100001000010000111110001110001110100111011010111101001110111000100001101010101111111111110110011100000000000101001101111011001010010001001110101110011110110100001010110010001101001111100100001010000100100010011110000100100100000101001011011001100010001111010001101101000011001010011101000011111101111100010001011000111000010000100011000110001000000011011000101001100110010100001000111010000011101100100001000101010110111001011111110010001110111010010111101111110010110001001101100010101111100000011011011011010010101010011111000011101000101110101001001110011010111100110001001011101000100010101001000111001111110111010000101001111001101001100111101001110101011010001100100010001011101010001110100111010000011000100101101011111110101001010001110110000100111100010001001011110101011001000000001101110110001101111110111000011111011100010100001110100100011100001111001100101111101001001111010011111000111110111111100000111010101110111011111110110010001111000010100011011000011111101111001011100000011111111101110101101111001000000100101100001010101101101110111110110100111000010001010100010110110000110111110110110101110000010010010000011101101111101000111101100110101010001000101101100101111010001111001001011110011010100110011100001110100100011101001111111001010110111111011000000000100101101011100111010101110110011001010100010011000000001011110111111110110010000001010111011110101011010101001011001100101111001011111100010110001101011000010111110100111000001110001110110001101001011100011011000001110001110101101011100000111001111111101101001101011110011000010010010000111001001110001011011001010100111001111001011001011001011011011000001111001010001010111101101111010011111100001100011001001110000110000110000111101010011010011101001110000110001010000110110101000001110001100110000111101011011101001110010111100010111101011010101111010111010011100001000110000000010111011110100111000001011110110001011011101101110110000011111101011011011000110010011000000000001101011011000010100010000100111100111110011011000010001101011101000110000110110001111010011100000111100011010000101000101010110000111110000000111000101110000100100000001111001101000100011101000101101100100110010100101000001000000110111011010110100100011010010110011101001011011101001000100000010010110111100101101110100100001001111010110011011111110110001010111000101101110111000000111011101010111101110111101010011011100011011000100000000000001101001110100010110001000010010100100111011101100010111000110110100101111000111101110110110111101100110110001100101000000111011111011111010010010001010011100000100001001101000000001100000001100110110000111111010100010111110110100011101010000000101000100011111100011100110101111110110100100010101101101101111010101111010011010010110100101011110011011011000101101010000111000111001011111011011100011101000111110110000010000100110011010101000010001101100111010101000000011110001011011000110000011011000010100101011110010011100000111101100001101100111010011001111101110100000101110000101110010101011110110010110100101010100010100100001100111100101001100010101101101001000110000011010001100111001011111001001101000000011000010111110101000011011001011111010101100111000001000111000100101110101010001011000111010011111101010110100011011110110110110101000101100001100100110011000111010010010100011100111110010111001001000111010011000011011100010001010101001100110001111000100110001010010111001110110010001000100111111000101101111101101111010110001001011001000101001101101000100001010101101011001110000100000110010001100011000111110101100111011001010111110111001000100100000111000110110000010000010100011010011000110101110111001110011011111011111110111110011011000100000111001100011111000001100011010111110010110010010001100101111000011001110110111011010000001100111101100100001110011011010110110110011101001000101100111101101011101111000010111011101101110000110000110001010101110010100000100100111010101010111111101110110110100011010111111101011000100011100111011101001110000010000000010101010011100100101011011000000101111101111101100110010111111101010000010111001101011101101010110101001111001011010111111100111010010101000111011010111010100101101110111000100000001100111001010010001011011110101001101111011111100111001110100010011110010001111110010010010111100110011010000111010001110001110000101010011100010101001101101100101001001101001100011110101110111101100100011101100000001111001101010010011011000001101111100011110110110111101110011000111010101111011000110100111010011101101111100010001001001100010101001111011010001000011110010101110100110100110100111011011110110001110101000101000001100100111011110001010000001110000011111101101110100101111101001011110010111000110110011010100011010111000000111101000000101101011010101111010101101";
}

?>
